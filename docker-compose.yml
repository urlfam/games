version: '3.8'
services:
  web:
    build: .
    container_name: puzzio-web-container
    ports:
      - '3000:3000'
    env_file:
      - .env.local
    environment:
      - NODE_ENV=production
    volumes:
      - ./data:/app/data
      - ./public/previews:/app/public/previews
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "require(''http'').get(''http://localhost:3000'', r=>{process.exit(r.statusCode===200?0:1)}).on(''error'',()=>process.exit(1))"',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 5s

  proxy:
    image: nginx:latest
    container_name: puzzio-proxy-container
    ports:
      - '127.0.0.1:8090:80'
      - '9999:9999'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./injector.js:/usr/share/nginx/html/injector.js:ro
    restart: unless-stopped
    command: '/bin/sh -c ''nginx -g "daemon off;"'''

  validator:
    build:
      context: .
      dockerfile: Dockerfile.validator
    image: puzzio-validator:latest
    container_name: puzzio-validator
    network_mode: host
    volumes:
      - ./test_game.py:/app/test_game.py:ro
      - ./validation-results:/app/results
    shm_size: '2gb' # Fix OOM issues with Chromium
    restart: unless-stopped
    command: tail -f /dev/null

  image-capturer:
    build:
      context: .
      dockerfile: Dockerfile.capturer
    container_name: puzzio-image-description
    restart: unless-stopped

  image-description:
    build:
      context: .
      dockerfile: Dockerfile.capturer
    image: puzzio-image-description:latest
    container_name: puzzio-image-description
    network_mode: host
    volumes:
      - ./capture_screenshot.py:/app/capture_screenshot.py:ro
      - ./gameplay_captures:/app/screenshots
    shm_size: '2gb'
    restart: unless-stopped
