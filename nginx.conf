events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Logs settings
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log debug;

    server {
        listen 9999;

        resolver 8.8.8.8 valid=30s;

        # Health check
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Game Proxy Logic
        # Matches /game/[slug]/...
        location ~ ^/game/(?<game_slug>[^/]+)(?<path>/.*)?$ {
            # Default path to index.html if empty
            if ($path = "") {
                set $path "/index.html";
            }
            if ($path = "/") {
                set $path "/index.html";
            }

            # Target Upstream
            set $upstream_host "games.crazygames.com";
            # Note: The structure on crazygames is usually /en_US/[slug]/index.html
            # We construct the URL dynamically.
            set $target_url "https://$upstream_host/en_US/$game_slug$path";

            proxy_pass $target_url;

            # Spoof Headers
            proxy_set_header Host $upstream_host;
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Origin "https://www.crazygames.com";
            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
            
            # Remove blocking headers
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_hide_header X-Content-Type-Options;

            # Rewrite content to keep user on our proxy
            # We need to replace absolute links to the game host with our proxy URL
            sub_filter_types text/html text/css text/javascript application/javascript application/json;
            sub_filter 'https://games.crazygames.com/en_US/$game_slug' '$scheme://$http_host/game/$game_slug';
            sub_filter 'https://games.crazygames.com' '$scheme://$http_host/game/$game_slug';
            sub_filter_once off;

            # Handle CORS
            add_header Access-Control-Allow-Origin *;
        }
    }
}
