events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 10s;

    proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m;

    server {
        listen 9999;
        server_name _;

        # Script d'injection anti-redirect
        location = /injector.js {
            default_type application/javascript;
            add_header Cache-Control "no-cache";
            add_header Access-Control-Allow-Origin "*" always;
            
            return 200 '(function(){console.log("[Anti-Redirect Puzzio.io]");var domains={"api.intentia.com":"147.93.7.103:9999/proxy/api.intentia.com","api.cld.com":"147.93.7.103:9999/proxy/api.cld.com","idx.liadm.com":"147.93.7.103:9999/proxy/idx.liadm.com","imasdk.googleapis.com":"147.93.7.103:9999/ima","imasdk.googleapis.co":"147.93.7.103:9999/ima","id.hadron.ad.gt":"147.93.7.103:9999/proxy/id.hadron.ad.gt","geo.privacymanager.io":"147.93.7.103:9999/proxy/geo.privacymanager.io","id.crwdcntrl.net":"147.93.7.103:9999/proxy/id.crwdcntrl.net","lb.eu-1-id5-sync.com":"147.93.7.103:9999/proxy/lb.eu-1-id5-sync.com","id5-sync.com":"147.93.7.103:9999/proxy/id5-sync.com","gum.criteo.com":"147.93.7.103:9999/proxy/gum.criteo.com","lexicon.33across.com":"147.93.7.103:9999/proxy/lexicon.33across.com"};function rewrite(url){if(!url)return url;try{if(url.includes("api.intentia.com")&&!url.includes("147.93.7")){url=url.replace(/https?:\\/\\/(www\\.)?api\\.intentia\\.com/g,"http://147.93.7.103:9999/proxy/api.intentia.com");console.log("[REWRITE AGGRESSIVE]",url);return url}var u=new URL(url,window.location.href);for(var d in domains){if(u.hostname===d||u.hostname.endsWith("."+d)){var n="http://"+domains[d]+u.pathname+u.search+u.hash;console.log("[REWRITE]",url,"->",n);return n}}return url}catch(e){console.error("[REWRITE ERROR]",e);return url}}var origFetch=window.fetch;window.fetch=function(input,init){var url=typeof input==="string"?input:input.url;var newURL=rewrite(url);if(newURL!==url){console.log("[FETCH REWRITTEN]",url,"->",newURL);input=typeof input==="string"?newURL:new Request(newURL,input)}return origFetch.call(this,input,init).catch(function(err){console.error("[FETCH ERROR]",url,err);throw err})};var origOpen=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(method,url){var newURL=rewrite(url);if(newURL!==url)console.log("[XHR REWRITTEN]",url,"->",newURL);return origOpen.call(this,method,newURL,arguments[2],arguments[3],arguments[4])};window.open=function(){console.warn("[BLOCKED] window.open");return null};var origAppend=Element.prototype.appendChild;Element.prototype.appendChild=function(child){if(child.tagName==="IFRAME"){var src=child.src||child.getAttribute("src");if(src&&src.startsWith("http")&&!src.includes("147.93.7.103")&&!src.includes("blob:")&&!src.includes("unity")){console.warn("[BLOCKED] External iframe:",src);return child}}return origAppend.call(this,child)};console.log("[Anti-Redirect] Active")})();';
        }

        # Proxy pour les fichiers de jeux (game-files)
        location ~ ^/game-files/(?<game_host>[^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            proxy_pass https://$game_host.game-files.crazygames.com/$2$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $game_host.game-files.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_buffering on;
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
        }

        # Proxy générique pour les APIs tierces
        location ~ ^/proxy/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $proxy_host $1;
            set $proxy_path $2;
            
            proxy_pass https://$proxy_host/$proxy_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $proxy_host;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_cache api_cache;
            proxy_cache_valid 200 5m;
            
            proxy_connect_timeout 15s;
            proxy_read_timeout 30s;
            proxy_buffering on;
        }

        # Proxy pour Google IMA SDK
        location ~ ^/ima/(.*) {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            proxy_pass https://imasdk.googleapis.com/$1$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host imasdk.googleapis.com;
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_connect_timeout 20s;
            proxy_read_timeout 30s;
        }

        # Proxy pour les jeux individuels
        location ~ ^/game/(?<game_slug>[^/]+)(?<game_path>/.*)?$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            # Si le chemin est vide, ajouter /index.html par défaut
            set $final_path $game_path;
            if ($game_path = "") {
                set $final_path "/index.html";
            }
            if ($game_path = "/") {
                set $final_path "/index.html";
            }

            proxy_pass https://games.crazygames.com/en_US/$game_slug$final_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host games.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_hide_header Access-Control-Allow-Origin;
            
            add_header Access-Control-Allow-Origin "*" always;
            add_header X-Frame-Options "ALLOWALL" always;
            
            sub_filter_types text/css text/javascript application/javascript application/json text/plain;
            sub_filter_once off;
            sub_filter_last_modified off;
            
            # Injecter le script anti-redirect dans le <head>
            sub_filter '<head>' '<head><script src="/injector.js"></script>';
            
            # Réécrire les game-files: {slug}.game-files.crazygames.com → 147.93.7.103:9999/game-files/{slug}
            sub_filter '$game_slug.game-files.crazygames.com' '147.93.7.103:9999/game-files/$game_slug';
            sub_filter '//$game_slug.game-files.crazygames.com' '//147.93.7.103:9999/game-files/$game_slug';
            sub_filter 'https://$game_slug.game-files.crazygames.com' 'http://147.93.7.103:9999/game-files/$game_slug';
            
            # Réécrire les appels API
            sub_filter 'https://api.intentia.com' 'http://147.93.7.103:9999/proxy/api.intentia.com';
            sub_filter '"https://api.intentia.com' '"http://147.93.7.103:9999/proxy/api.intentia.com';
            sub_filter "'https://api.intentia.com" "'http://147.93.7.103:9999/proxy/api.intentia.com";
            sub_filter '//api.intentia.com' '//147.93.7.103:9999/proxy/api.intentia.com';
            sub_filter 'api.intentia.com' '147.93.7.103:9999/proxy/api.intentia.com';
            
            # Réécrire IMA SDK
            sub_filter 'https://imasdk.googleapis.com' 'http://147.93.7.103:9999/ima';
            sub_filter '//imasdk.googleapis.com' '//147.93.7.103:9999/ima';
            
            # Désactiver les protections d'embedding
            sub_filter 'disableEmbedding":true' 'disableEmbedding":false';
            sub_filter '"canEmbed":false' '"canEmbed":true';
            sub_filter 'allowFullscreen":false' 'allowFullscreen":true';
        }

        location = /favicon.ico {
            return 204;
        }

        location = / {
            add_header Content-Type text/plain;
            return 200 "Puzzio.io Game Proxy - Ready\n";
        }

        location / {
            return 404;
        }
    }
}
