'use client'

import { useState, useEffect, useCallback } from 'react'
import { createClient } from '@/lib/supabase/client'
import { Star, ThumbsUp, Reply, Trash2, Edit2, Send, User as UserIcon } from 'lucide-react'

interface Comment {
  id: string
  user_id: string | null
  game_slug: string
  content: string
  rating: number | null
  parent_id: string | null
  likes_count: number
  created_at: string
  updated_at: string
  username: string
  user_liked?: boolean
  replies?: Comment[]
}

interface GameCommentsProps {
  gameSlug: string
}

export default function GameComments({ gameSlug }: GameCommentsProps) {
  const [comments, setComments] = useState<Comment[]>([])
  const [loading, setLoading] = useState(true)
  const [newComment, setNewComment] = useState('')
  const [username, setUsername] = useState('')
  const [newRating, setNewRating] = useState<number>(0)
  const [hoverRating, setHoverRating] = useState<number>(0)
  const [replyingTo, setReplyingTo] = useState<string | null>(null)
  const [replyContent, setReplyContent] = useState('')
  const [submitting, setSubmitting] = useState(false)
  
  const supabase = createClient()

  // Load username from localStorage
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const savedUsername = localStorage.getItem('puzzio_username') || '';
      setUsername(savedUsername);
    }
  }, [])

  const fetchComments = useCallback(async () => {
    try {
      const { data: commentsData, error } = await supabase
        .from('comments')
        .select(`
          *,
          users (
            username,
            avatar_url
          )
        `)
        .eq('game_slug', gameSlug)
        .is('parent_id', null)
        .order('created_at', { ascending: false })

      if (error) throw error

      const commentsWithReplies = await Promise.all(
        (commentsData || []).map(async (comment) => {
          const { data: repliesData } = await supabase
            .from('comments')
            .select(`
              *,
              users (
                username,
                avatar_url
              )
            `)
            .eq('parent_id', comment.id)
            .order('created_at', { ascending: true })

          if (user) {
            const { data: likeData } = await supabase
              .from('comment_likes')
              .select('comment_id')
              .eq('user_id', user.id)
              .in('comment_id', [comment.id, ...(repliesData || []).map(r => r.id)])

            const likedIds = new Set(likeData?.map(l => l.comment_id) || [])
            
            return {
              ...comment,
              user_liked: likedIds.has(comment.id),
              replies: (repliesData || []).map(reply => ({
                ...reply,
                user_liked: likedIds.has(reply.id)
              }))
            }
          }

          return {
            ...comment,
            replies: repliesData || []
          }
        })
      )

      setComments(commentsWithReplies)
    } catch (error) {
      console.error('Error fetching comments:', error)
    } finally {
      setLoading(false)
    }
  }, [gameSlug, user, supabase])

  useEffect(() => {
    fetchComments()

    const channel = supabase
      .channel(`comments:${gameSlug}`)
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'comments',
          filter: `game_slug=eq.${gameSlug}`
        },
        () => {
          fetchComments()
        }
      )
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [gameSlug, user, supabase, fetchComments])

  const handleSubmitComment = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!user || !newComment.trim() || submitting) return

    setSubmitting(true)
    try {
      const { error } = await supabase
        .from('comments')
        .insert([
          {
            user_id: user.id,
            game_slug: gameSlug,
            content: newComment.trim(),
            rating: newRating > 0 ? newRating : null
          }
        ])

      if (error) throw error

      setNewComment('')
      setNewRating(0)
      fetchComments()
    } catch (error) {
      console.error('Error submitting comment:', error)
      alert('Failed to post comment. Please try again.')
    } finally {
      setSubmitting(false)
    }
  }

  const handleSubmitReply = async (parentId: string) => {
    if (!user || !replyContent.trim() || submitting) return

    setSubmitting(true)
    try {
      const { error } = await supabase
        .from('comments')
        .insert([
          {
            user_id: user.id,
            game_slug: gameSlug,
            content: replyContent.trim(),
            parent_id: parentId
          }
        ])

      if (error) throw error

      setReplyContent('')
      setReplyingTo(null)
      fetchComments()
    } catch (error) {
      console.error('Error submitting reply:', error)
      alert('Failed to post reply. Please try again.')
    } finally {
      setSubmitting(false)
    }
  }

  const handleEditComment = async (commentId: string) => {
    if (!user || !editContent.trim() || submitting) return

    setSubmitting(true)
    try {
      const { error } = await supabase
        .from('comments')
        .update({ content: editContent.trim(), updated_at: new Date().toISOString() })
        .eq('id', commentId)
        .eq('user_id', user.id)

      if (error) throw error

      setEditContent('')
      setEditingComment(null)
      fetchComments()
    } catch (error) {
      console.error('Error editing comment:', error)
      alert('Failed to edit comment. Please try again.')
    } finally {
      setSubmitting(false)
    }
  }

  const handleDeleteComment = async (commentId: string) => {
    if (!user || submitting) return
    if (!confirm('Are you sure you want to delete this comment?')) return

    setSubmitting(true)
    try {
      const { error } = await supabase
        .from('comments')
        .delete()
        .eq('id', commentId)
        .eq('user_id', user.id)

      if (error) throw error

      fetchComments()
    } catch (error) {
      console.error('Error deleting comment:', error)
      alert('Failed to delete comment. Please try again.')
    } finally {
      setSubmitting(false)
    }
  }

  const handleLikeComment = async (commentId: string, currentlyLiked: boolean) => {
    if (!user) return

    try {
      if (currentlyLiked) {
        await supabase
          .from('comment_likes')
          .delete()
          .eq('comment_id', commentId)
          .eq('user_id', user.id)
      } else {
        await supabase
          .from('comment_likes')
          .insert([{ comment_id: commentId, user_id: user.id }])
      }

      fetchComments()
    } catch (error) {
      console.error('Error toggling like:', error)
    }
  }

  const renderStars = (rating: number, interactive: boolean = false) => {
    return (
      <div className="flex gap-1">
        {[1, 2, 3, 4, 5].map((star) => (
          <Star
            key={star}
            size={interactive ? 24 : 16}
            className={`${
              star <= (interactive ? (hoverRating || newRating) : rating)
                ? 'fill-yellow-400 text-yellow-400'
                : 'text-gray-300'
            } ${interactive ? 'cursor-pointer hover:scale-110 transition-transform' : ''}`}
            onClick={() => interactive && setNewRating(star)}
            onMouseEnter={() => interactive && setHoverRating(star)}
            onMouseLeave={() => interactive && setHoverRating(0)}
          />
        ))}
      </div>
    )
  }

  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    const now = new Date()
    const diffMs = now.getTime() - date.getTime()
    const diffMins = Math.floor(diffMs / 60000)
    const diffHours = Math.floor(diffMins / 60)
    const diffDays = Math.floor(diffHours / 24)

    if (diffMins < 1) return 'just now'
    if (diffMins < 60) return `${diffMins}m ago`
    if (diffHours < 24) return `${diffHours}h ago`
    if (diffDays < 7) return `${diffDays}d ago`
    return date.toLocaleDateString()
  }

  const renderComment = (comment: Comment, isReply: boolean = false) => {
    const isEditing = editingComment === comment.id
    const isOwner = user?.id === comment.user_id

    return (
      <div
        key={comment.id}
        className={`${isReply ? 'ml-12 mt-3' : 'mt-4'} bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700`}
      >
        <div className="flex items-start gap-3">
          <div className="flex-shrink-0">
            {comment.users.avatar_url ? (
              <Image
                src={comment.users.avatar_url}
                alt={comment.users.username}
                width={40}
                height={40}
                className="rounded-full"
              />
            ) : (
              <div className="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold">
                {comment.users.username[0].toUpperCase()}
              </div>
            )}
          </div>

          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 mb-1">
              <span className="font-semibold text-gray-900 dark:text-white">
                {comment.users.username}
              </span>
              <span className="text-sm text-gray-500">
                {formatDate(comment.created_at)}
              </span>
              {comment.rating && !isReply && (
                <div className="ml-auto">
                  {renderStars(comment.rating)}
                </div>
              )}
            </div>

            {isEditing ? (
              <div className="mt-2">
                <textarea
                  value={editContent}
                  onChange={(e) => setEditContent(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:text-white resize-none"
                  rows={3}
                  placeholder="Edit your comment..."
                />
                <div className="flex gap-2 mt-2">
                  <button
                    onClick={() => handleEditComment(comment.id)}
                    disabled={submitting}
                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors disabled:opacity-50"
                  >
                    Save
                  </button>
                  <button
                    onClick={() => {
                      setEditingComment(null)
                      setEditContent('')
                    }}
                    className="px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-white rounded-lg transition-colors"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              <>
                <p className="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
                  {comment.content}
                </p>

                <div className="flex items-center gap-4 mt-3">
                  <button
                    onClick={() => handleLikeComment(comment.id, comment.user_liked || false)}
                    disabled={!user}
                    className={`flex items-center gap-1 text-sm ${
                      comment.user_liked
                        ? 'text-purple-600 dark:text-purple-400'
                        : 'text-gray-500 hover:text-purple-600 dark:hover:text-purple-400'
                    } transition-colors disabled:opacity-50`}
                  >
                    <ThumbsUp size={16} className={comment.user_liked ? 'fill-current' : ''} />
                    <span>{comment.likes_count || 0}</span>
                  </button>

                  {!isReply && user && (
                    <button
                      onClick={() => setReplyingTo(comment.id)}
                      className="flex items-center gap-1 text-sm text-gray-500 hover:text-purple-600 dark:hover:text-purple-400 transition-colors"
                    >
                      <Reply size={16} />
                      <span>Reply</span>
                    </button>
                  )}

                  {isOwner && (
                    <>
                      <button
                        onClick={() => {
                          setEditingComment(comment.id)
                          setEditContent(comment.content)
                        }}
                        className="flex items-center gap-1 text-sm text-gray-500 hover:text-blue-600 transition-colors"
                      >
                        <Edit2 size={16} />
                        <span>Edit</span>
                      </button>
                      <button
                        onClick={() => handleDeleteComment(comment.id)}
                        disabled={submitting}
                        className="flex items-center gap-1 text-sm text-gray-500 hover:text-red-600 transition-colors disabled:opacity-50"
                      >
                        <Trash2 size={16} />
                        <span>Delete</span>
                      </button>
                    </>
                  )}
                </div>
              </>
            )}

            {replyingTo === comment.id && (
              <div className="mt-3">
                <textarea
                  value={replyContent}
                  onChange={(e) => setReplyContent(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:text-white resize-none"
                  rows={3}
                  placeholder="Write a reply..."
                />
                <div className="flex gap-2 mt-2">
                  <button
                    onClick={() => handleSubmitReply(comment.id)}
                    disabled={submitting}
                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center gap-2"
                  >
                    <Send size={16} />
                    Reply
                  </button>
                  <button
                    onClick={() => {
                      setReplyingTo(null)
                      setReplyContent('')
                    }}
                    className="px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-white rounded-lg transition-colors"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>

        {comment.replies && comment.replies.length > 0 && (
          <div className="mt-2">
            {comment.replies.map((reply) => renderComment(reply, true))}
          </div>
        )}
      </div>
    )
  }

  if (loading) {
    return (
      <div className="mt-8 space-y-4">
        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Comments</h2>
        <div className="animate-pulse space-y-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="bg-gray-200 dark:bg-gray-700 h-32 rounded-lg" />
          ))}
        </div>
      </div>
    )
  }

  return (
    <div className="mt-8">
      <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6">
        Comments ({comments.length})
      </h2>

      {user ? (
        <form onSubmit={handleSubmitComment} className="mb-6 bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0">
              {user.user_metadata?.avatar_url ? (
                <Image
                  src={user.user_metadata.avatar_url}
                  alt={user.user_metadata?.full_name || 'You'}
                  width={40}
                  height={40}
                  className="rounded-full"
                />
              ) : (
                <div className="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold">
                  {user.email?.[0].toUpperCase()}
                </div>
              )}
            </div>
            <div className="flex-1">
              <textarea
                value={newComment}
                onChange={(e) => setNewComment(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:text-white resize-none"
                rows={4}
                placeholder="Share your thoughts about this game..."
                required
              />
              <div className="flex items-center justify-between mt-3">
                <div className="flex items-center gap-3">
                  <span className="text-sm text-gray-600 dark:text-gray-400">Rate this game:</span>
                  {renderStars(newRating, true)}
                </div>
                <button
                  type="submit"
                  disabled={submitting || !newComment.trim()}
                  className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                >
                  <Send size={16} />
                  Post Comment
                </button>
              </div>
            </div>
          </div>
        </form>
      ) : (
        <div className="mb-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 text-center">
          <p className="text-blue-800 dark:text-blue-200">
            Please sign in to leave a comment
          </p>
        </div>
      )}

      {comments.length === 0 ? (
        <div className="text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-lg">
          <p className="text-gray-500 dark:text-gray-400">
            No comments yet. Be the first to share your thoughts!
          </p>
        </div>
      ) : (
        <div className="space-y-1">
          {comments.map((comment) => renderComment(comment))}
        </div>
      )}
    </div>
  )
}
