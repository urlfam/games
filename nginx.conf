events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Compression Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;
    gzip_min_length 1000;

    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 10s;

    proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m;

    server {
        listen 80;  # Pour le site web principal (Next.js)
        server_name _;

        # Next.js App
        location / {
            proxy_pass http://puzzio-web-container:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            
            # Headers standards pour Next.js derrière un proxy
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https; # On force HTTPS car on sait qu'on est accédé en HTTPS
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 443;
            
            proxy_cache_bypass $http_upgrade;

            # OPTIMISATION VITESSE (MICRO-CACHING)
            # Cache la page d'accueil et les pages de jeux pour un chargement INSTANTANÉ
            proxy_cache api_cache;
            proxy_cache_valid 200 60s; # Cache de 60s (aligné avec ISR Next.js)
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;
            
            # Clé de cache incluant l'URL complète (avec query params)
            proxy_cache_key "$scheme$request_method$host$request_uri";

            # Ne pas cacher si l'utilisateur est connecté (Supabase auth) ou utilise la recherche
            proxy_cache_bypass $cookie_sb_access_token $arg_search;
            proxy_no_cache $cookie_sb_access_token $arg_search;

            # Ignorer les headers de cache de Next.js pour imposer notre politique Nginx
            proxy_ignore_headers Cache-Control Expires;

            # Debug Header (pour vérifier si le cache fonctionne)
            add_header X-Cache-Status $upstream_cache_status;
        }

        # IMPORTANT: Pas de route /game/ ici pour éviter le conflit avec Next.js
        # Uniquement /source-game/ pour l'iframe
        
        # Script d'injection anti-pub v2.0 (fichier externe)
        location = /injector.js {
            alias /usr/share/nginx/html/injector.js;
            default_type application/javascript;
            expires 1h;
            add_header Cache-Control "public, no-transform";
            add_header Access-Control-Allow-Origin "*" always;
        }

        # Proxy pour les fichiers de jeux (game-files) - Commun
        location ~ ^/game-files/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $subdomain $1;
            set $filepath $2;

            proxy_pass https://$subdomain.game-files.crazygames.com/$filepath$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $subdomain.game-files.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";  
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_buffering on;
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
        }

        # Proxy pour les APIs tierces - Commun
        location ~ ^/proxy/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $proxy_host $1;
            set $proxy_path $2;
            
            # BLOQUER LES DOMAINES PUBLICITAIRES CONNUS
            # On retourne 204 (No Content) pour simuler une réponse vide mais "succès" ou 403
            if ($proxy_host ~* "(gum\.criteo\.com|idx\.liadm\.com|id\.hadron\.ad\.gt|api\.intentia\.com|pubmatic\.com|rubiconproject\.com|openx\.net|dn09\.com|googlesyndication\.com|doubleclick\.net)") {
                add_header Action "Blocked-Ad-Domain" always;
                return 204;
            }

            proxy_pass https://$proxy_host/$proxy_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $proxy_host;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_cache api_cache;
            proxy_cache_valid 200 5m;
            
            proxy_connect_timeout 15s;
            proxy_read_timeout 30s;
            proxy_buffering on;
        }

        # NEUTRALISER GOOGLE IMA SDK (Anti-Pub)
        # Au lieu de proxy, on retourne un contenu vide (204)
        # Cela empêche le chargement du VRAI script IMA, laissant notre Mock (injector.js) actif !
        location ~ ^/ima/(.*) {
            add_header Content-Type application/javascript;
            add_header Access-Control-Allow-Origin "*" always;
            return 200 "console.log('IMA SDK Blocked by Puzzio');";
        }

        # Proxy pour les jeux individuels (/source-game/)
        location ~ ^/source-game/(?<game_slug>[^/]+)(?<game_path>/.*)?$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $final_path $game_path;
            if ($game_path = "") {
                set $final_path "/index.html";
            }
            if ($game_path = "/") {
                set $final_path "/index.html";
            }

            proxy_pass https://games.crazygames.com/en_US/$game_slug$final_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host games.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept-Encoding "";  
            
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_hide_header Access-Control-Allow-Origin;
            
            add_header Access-Control-Allow-Origin "*" always;
            add_header X-Frame-Options "ALLOWALL" always;
            
            sub_filter_types text/html text/css text/javascript application/javascript application/json text/plain;
            sub_filter_once off;
            sub_filter_last_modified off;
            
            sub_filter '<head>' '<head><script src="/injector.js"></script>';

            # Bloquer le chargement du VRAI SDK CrazyGames pour forcer l'utilisation de notre Mock
            sub_filter 'https://sdk.crazygames.com/crazygames-sdk-v1.js' '/injector.js';
            sub_filter 'sdk.crazygames.com/crazygames-sdk-v1.js' '/injector.js';
            
            # Réécrire les appels API
            sub_filter 'https://api.intentia.com' '/proxy/api.intentia.com';
            sub_filter '"https://api.intentia.com' '"/proxy/api.intentia.com';
            sub_filter "'https://api.intentia.com" "'/proxy/api.intentia.com";
            
            # Réécrire IMA SDK
            sub_filter 'https://imasdk.googleapis.com' '/ima';
            sub_filter '//imasdk.googleapis.com' '//puzzio.io/ima';
            
            # Canonical URL (SEO)
            sub_filter 'rel="canonical" href="https://www.crazygames.com' 'rel="canonical" href="https://puzzio.io';
            sub_filter 'rel="canonical" href="https://crazygames.com' 'rel="canonical" href="https://puzzio.io';
            
            # Open Graph URL
            sub_filter 'property="og:url" content="https://www.crazygames.com' 'property="og:url" content="https://puzzio.io';
            sub_filter 'property="og:url" content="https://crazygames.com' 'property="og:url" content="https://puzzio.io';
            
            # Twitter Card URL
            sub_filter 'name="twitter:url" content="https://www.crazygames.com' 'name="twitter:url" content="https://puzzio.io';
            sub_filter 'name="twitter:url" content="https://crazygames.com' 'name="twitter:url" content="https://puzzio.io';
            
            # Liens internes génériques
            sub_filter 'href="https://www.crazygames.com' 'href="https://puzzio.io';
            sub_filter 'href="https://crazygames.com' 'href="https://puzzio.io';
            sub_filter 'https://www.crazygames.com' 'https://puzzio.io';
            
            # Désactiver les protections d'embedding
            sub_filter 'disableEmbedding":true' 'disableEmbedding":false';
            sub_filter '"canEmbed":false' '"canEmbed":true';
            sub_filter 'allowFullscreen":false' 'allowFullscreen":true';

            # DESACTIVER LES PUBS DANS LE LOADER (Fix Loading 10s)
            sub_filter '"showAdOnExternal":"ALWAYS"' '"showAdOnExternal":"NEVER"';
            sub_filter '"showAdOnInternal":"DEFAULT"' '"showAdOnInternal":"NEVER"';
            sub_filter '"showAdOnInternal":"ALWAYS"' '"showAdOnInternal":"NEVER"';
        }

        location = /favicon.ico {
            return 204;
        }

        location /health {
            add_header Content-Type text/plain;
            return 200 "OK\n";
        }
    }

    server {
        listen 9999; # Pour les workflows n8n et accès direct
        server_name _;

        # Pas de route vers le web container, on veut juste le proxy direct

        # Duplicate: Script d'injection
        location = /injector.js {
            alias /usr/share/nginx/html/injector.js;
            default_type application/javascript;
            expires 1h;
            add_header Cache-Control "public, no-transform";
            add_header Access-Control-Allow-Origin "*" always;
        }

        # Duplicate: Proxy pour les fichiers de jeux
        location ~ ^/game-files/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $subdomain $1;
            set $filepath $2;

            proxy_pass https://$subdomain.game-files.crazygames.com/$filepath$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $subdomain.game-files.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";  
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_buffering on;
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
        }

        # Duplicate: Proxy pour les APIs tierces 
        location ~ ^/proxy/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $proxy_host $1;
            set $proxy_path $2;

            # BLOQUER LES DOMAINES PUBLICITAIRES CONNUS
            if ($proxy_host ~* "(gum\.criteo\.com|idx\.liadm\.com|id\.hadron\.ad\.gt|api\.intentia\.com|pubmatic\.com|rubiconproject\.com|openx\.net|dn09\.com|googlesyndication\.com|doubleclick\.net)") {
                add_header Action "Blocked-Ad-Domain" always;
                return 204;
            }
            
            proxy_pass https://$proxy_host/$proxy_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $proxy_host;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_cache api_cache;
            proxy_cache_valid 200 5m;
            
            proxy_connect_timeout 15s;
            proxy_read_timeout 30s;
            proxy_buffering on;
        }

        # Duplicate: Neutraliser Google IMA SDK
        location ~ ^/ima/(.*) {
            add_header Content-Type application/javascript;
            add_header Access-Control-Allow-Origin "*" always;
            return 200 "console.log('IMA SDK Blocked by Puzzio');";
        }


        # ICI: On remet /game/ (et /source-game/) pour le port 9999 !!
        location ~ ^/(game|source-game)/(?<game_slug>[^/]+)(?<game_path>/.*)?$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $final_path $game_path;
            if ($game_path = "") {
                set $final_path "/index.html";
            }
            if ($game_path = "/") {
                set $final_path "/index.html";
            }

            proxy_pass https://games.crazygames.com/en_US/$game_slug$final_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host games.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept-Encoding "";  
            
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_hide_header Access-Control-Allow-Origin;
            
            add_header Access-Control-Allow-Origin "*" always;
            add_header X-Frame-Options "ALLOWALL" always;
            
            sub_filter_types text/html text/css text/javascript application/javascript application/json text/plain;
            sub_filter_once off;
            sub_filter_last_modified off;
            
            sub_filter '<head>' '<head><script src="/injector.js"></script>';

            # Bloquer le chargement du VRAI SDK CrazyGames pour forcer l'utilisation de notre Mock
            sub_filter 'https://sdk.crazygames.com/crazygames-sdk-v1.js' '/injector.js';
            sub_filter 'sdk.crazygames.com/crazygames-sdk-v1.js' '/injector.js';
            
            # Réécrire les appels API
            sub_filter 'https://api.intentia.com' '/proxy/api.intentia.com';
            sub_filter '"https://api.intentia.com' '"/proxy/api.intentia.com';
            sub_filter "'https://api.intentia.com" "'/proxy/api.intentia.com";
            
            # Réécrire IMA SDK
            sub_filter 'https://imasdk.googleapis.com' '/ima';
            sub_filter '//imasdk.googleapis.com' '//puzzio.io/ima';
            
            # Canonical URL (SEO)
            sub_filter 'rel="canonical" href="https://www.crazygames.com' 'rel="canonical" href="https://puzzio.io';
            sub_filter 'rel="canonical" href="https://crazygames.com' 'rel="canonical" href="https://puzzio.io';
            
            # Open Graph URL
            sub_filter 'property="og:url" content="https://www.crazygames.com' 'property="og:url" content="https://puzzio.io';
            sub_filter 'property="og:url" content="https://crazygames.com' 'property="og:url" content="https://puzzio.io';
            
            # Twitter Card URL
            sub_filter 'name="twitter:url" content="https://www.crazygames.com' 'name="twitter:url" content="https://puzzio.io';
            sub_filter 'name="twitter:url" content="https://crazygames.com' 'name="twitter:url" content="https://puzzio.io';
            
            # Liens internes génériques
            sub_filter 'href="https://www.crazygames.com' 'href="https://puzzio.io';
            sub_filter 'href="https://crazygames.com' 'href="https://puzzio.io';
            sub_filter 'https://www.crazygames.com' 'https://puzzio.io';
            
            # Désactiver les protections d'embedding
            sub_filter 'disableEmbedding":true' 'disableEmbedding":false';
            sub_filter '"canEmbed":false' '"canEmbed":true';
            sub_filter 'allowFullscreen":false' 'allowFullscreen":true';

            # DESACTIVER LES PUBS DANS LE LOADER (Fix Loading 10s)
            sub_filter '"showAdOnExternal":"ALWAYS"' '"showAdOnExternal":"NEVER"';
            sub_filter '"showAdOnInternal":"DEFAULT"' '"showAdOnInternal":"NEVER"';
            sub_filter '"showAdOnInternal":"ALWAYS"' '"showAdOnInternal":"NEVER"';
        }
    }
}