events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Compression Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;
    gzip_min_length 1000;

    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 10s;

    proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m;

    # HTTP Server - Redirect to HTTPS
    server {
        listen 80;
        server_name puzzio.io www.puzzio.io;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS Server
    server {
        listen 443 ssl;
        server_name puzzio.io www.puzzio.io;

        ssl_certificate /etc/letsencrypt/live/puzzio.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/puzzio.io/privkey.pem;
        
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        location / {
            proxy_pass http://puzzio-web-container:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
        
        # Script d'injection anti-pub v2.0 (fichier externe)
        location = /injector.js {
            alias /usr/share/nginx/html/injector.js;
            default_type application/javascript;
            expires 1h;
            add_header Cache-Control "public, no-transform";
            add_header Access-Control-Allow-Origin "*" always;
        }

        # Proxy pour les fichiers de jeux (game-files)
        location ~ ^/game-files/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $subdomain $1;
            set $filepath $2;

            proxy_pass https://$subdomain.game-files.crazygames.com/$filepath$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $subdomain.game-files.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";  
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_buffering on;
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
        }

        # Proxy générique pour les APIs tierces
        location ~ ^/proxy/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $proxy_host $1;
            set $proxy_path $2;
            
            proxy_pass https://$proxy_host/$proxy_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $proxy_host;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_cache api_cache;
            proxy_cache_valid 200 5m;
            
            proxy_connect_timeout 15s;
            proxy_read_timeout 30s;
            proxy_buffering on;
        }
    }

    server {
        listen 9999;
        server_name _;
        
        # Keep 9999 logic same as before if needed or just redirect too? 
        # For safety I'll replicate the core logic here so 9999 still works without SSL if for some reason needed
        
        location / {
            proxy_pass http://puzzio-web-container:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
}