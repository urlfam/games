events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Compression Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;
    gzip_min_length 1000;

    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 10s;

    proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m;

    server {
        listen 80;
        server_name puzzio.io www.puzzio.io;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            proxy_pass http://puzzio-web-container:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
        
        # Script d'injection anti-pub v2.0 (fichier externe)
        location = /injector.js {
            alias /usr/share/nginx/html/injector.js;
            default_type application/javascript;
            expires 1h;
            add_header Cache-Control "public, no-transform";
            add_header Access-Control-Allow-Origin "*" always;
        }

        # Proxy pour les fichiers de jeux (game-files)
        location ~ ^/game-files/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $subdomain $1;
            set $filepath $2;

            proxy_pass https://$subdomain.game-files.crazygames.com/$filepath$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $subdomain.game-files.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";  
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_buffering on;
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
        }

        # Proxy générique pour les APIs tierces
        location ~ ^/proxy/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $proxy_host $1;
            set $proxy_path $2;
            
            proxy_pass https://$proxy_host/$proxy_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $proxy_host;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_cache api_cache;
            proxy_cache_valid 200 5m;
            
            proxy_connect_timeout 15s;
            proxy_read_timeout 30s;
            proxy_buffering on;
        }
    }

    server {
        listen 9999;
        server_name _;

        # Script d'injection anti-pub v2.0 (fichier externe)
        location = /injector.js {
            alias /usr/share/nginx/html/injector.js;
            default_type application/javascript;
            expires 1h;
            add_header Cache-Control "public, no-transform";
            add_header Access-Control-Allow-Origin "*" always;
        }

        # Proxy pour les fichiers de jeux (game-files)
        # Format attendu: /game-files/{subdomain}/path → https://{subdomain}.game-files.crazygames.com/path
        location ~ ^/game-files/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $subdomain $1;
            set $filepath $2;

            proxy_pass https://$subdomain.game-files.crazygames.com/$filepath$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $subdomain.game-files.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";  # Force décompression pour sub_filter
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_buffering on;
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
        }

        # Proxy générique pour les APIs tierces
        location ~ ^/proxy/([^/]+)/(.*)$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            set $proxy_host $1;
            set $proxy_path $2;
            
            proxy_pass https://$proxy_host/$proxy_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host $proxy_host;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept "*/*";
            proxy_set_header Referer "https://www.crazygames.com/";
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_cache api_cache;
            proxy_cache_valid 200 5m;
            
            proxy_connect_timeout 15s;
            proxy_read_timeout 30s;
            proxy_buffering on;
        }

        # Proxy pour Google IMA SDK
        location ~ ^/ima/(.*) {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            proxy_pass https://imasdk.googleapis.com/$1$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host imasdk.googleapis.com;
            proxy_set_header Accept-Encoding "";
            
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_connect_timeout 20s;
            proxy_read_timeout 30s;
        }

        # Proxy pour les jeux individuels
        location ~ ^/game/(?<game_slug>[^/]+)(?<game_path>/.*)?$ {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                return 204;
            }

            # Si le chemin est vide, ajouter /index.html par défaut
            set $final_path $game_path;
            if ($game_path = "") {
                set $final_path "/index.html";
            }
            if ($game_path = "/") {
                set $final_path "/index.html";
            }

            proxy_pass https://games.crazygames.com/en_US/$game_slug$final_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            proxy_set_header Host games.crazygames.com;
            proxy_set_header User-Agent "Mozilla/5.0";
            proxy_set_header Accept-Encoding "";  # CRITIQUE : Force décompression pour sub_filter
            
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_hide_header Access-Control-Allow-Origin;
            
            add_header Access-Control-Allow-Origin "*" always;
            add_header X-Frame-Options "ALLOWALL" always;
            
            sub_filter_types text/html text/css text/javascript application/javascript application/json text/plain;
            sub_filter_once off;
            sub_filter_last_modified off;
            
            # Injecter le script anti-redirect dans le <head>
            sub_filter '<head>' '<head><script src="/injector.js"></script>';
            
            # Note: Les game-files sont gérés par le JavaScript injector
            # car sub_filter ne supporte pas les regex pour capturer les subdomains dynamiquement
            
            # Réécrire les appels API
            sub_filter 'https://api.intentia.com' 'http://147.93.7.103:9999/proxy/api.intentia.com';
            sub_filter '"https://api.intentia.com' '"http://147.93.7.103:9999/proxy/api.intentia.com';
            sub_filter "'https://api.intentia.com" "'http://147.93.7.103:9999/proxy/api.intentia.com";
            sub_filter '//api.intentia.com' '//147.93.7.103:9999/proxy/api.intentia.com';
            sub_filter 'api.intentia.com' '147.93.7.103:9999/proxy/api.intentia.com';
            
            # Réécrire IMA SDK
            sub_filter 'https://imasdk.googleapis.com' 'http://147.93.7.103:9999/ima';
            sub_filter '//imasdk.googleapis.com' '//147.93.7.103:9999/ima';
            
            # ============================================
            # SEO HIJACKING - Remplacer CrazyGames par notre domaine
            # ============================================
            # Canonical URL (CRITIQUE pour SEO)
            sub_filter 'rel="canonical" href="https://www.crazygames.com' 'rel="canonical" href="http://147.93.7.103';
            sub_filter 'rel="canonical" href="https://crazygames.com' 'rel="canonical" href="http://147.93.7.103';
            
            # Open Graph URL (partages sociaux)
            sub_filter 'property="og:url" content="https://www.crazygames.com' 'property="og:url" content="http://147.93.7.103';
            sub_filter 'property="og:url" content="https://crazygames.com' 'property="og:url" content="http://147.93.7.103';
            
            # Twitter Card URL
            sub_filter 'name="twitter:url" content="https://www.crazygames.com' 'name="twitter:url" content="http://147.93.7.103';
            sub_filter 'name="twitter:url" content="https://crazygames.com' 'name="twitter:url" content="http://147.93.7.103';
            
            # Liens internes génériques
            sub_filter 'href="https://www.crazygames.com' 'href="http://147.93.7.103';
            sub_filter 'href="https://crazygames.com' 'href="http://147.93.7.103';
            sub_filter 'https://www.crazygames.com' 'http://147.93.7.103';
            
            # ============================================
            # Désactiver les protections d'embedding
            # ============================================
            sub_filter 'disableEmbedding":true' 'disableEmbedding":false';
            sub_filter '"canEmbed":false' '"canEmbed":true';
            sub_filter 'allowFullscreen":false' 'allowFullscreen":true';
        }

        location = /favicon.ico {
            return 204;
        }

        location = / {
            add_header Content-Type text/plain;
            return 200 "Puzzio.io Game Proxy - Ready\n";
        }

        location / {
            return 404;
        }
    }
}
